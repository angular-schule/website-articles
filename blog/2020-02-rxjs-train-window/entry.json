{"slug":"2020-02-rxjs-train-window","html":"<p>Imagine yourself sitting in a train, landscapes passing by â€“ trees, houses, sheep, people, hills, ...\nWhen I find myself in a situation like that I can&#39;t help but thinking of reactive data streams all the time.</p>\n<p>All the things that rush by are items of a huge stream, and you subscribe to that Observable by watching through the window.\nHowever, here&#39;s an important detail: Whenever a new object appears outside, the window moves forward and opens the view to not just the recent <em>one</em> â€“ but to the <em>last few emitted items</em>.</p>\n<p><img src=\"%%MARKDOWN_BASE_URL%%/blog/2020-02-rxjs-train-window/train.gif\" alt=\"GIF of someone sitting in a train\">\n<br><small>(GIF source: giphy.com)</small></p>\n<p>Luckily there&#39;s more behind this than my peculiar interest for watching through train windows, so let&#39;s bring this example to the world of software.\nImagine an event stream â€“ this could be log messages, button clicks, or whatever Observable stream you like.\nWe want to build a UI around this that displays a chronological log of those events.\nJust like the train window delimits the number of trees we can see at a time, we only want to display a certain range of the event history â€“ the last few.</p>\n<p>When you look into the direction of travel, new items always appear at the front and disappear behind you. We want to adopt this analogy and display the newest element at the top of the list before it runs to the bottom and eventually disappears.</p>\n<p><img src=\"%%MARKDOWN_BASE_URL%%/blog/2020-02-rxjs-train-window/loghistory.gif\" alt=\"Animated GIF of a demo application with a log history\"></p>\n<h2 id=\"a-look-into-the-documentation\">A look into the documentation</h2>\n<p>My first approach to tackling reactive problems is a quick look into the <a href=\"https://rxjs.dev/api\">RxJS API documentation</a>.\nIt&#39;s very likely that an operator exists for solving the problem.\nHowever, it&#39;s important to not let yourself confuse by the number of operators, especially those who sound suitable at first glance.\nFor a few minutes, I was obsessed with the thought that one of the <code>buffer</code> or <code>window</code> operators might be the solution.\nThey are not! Both <code>buffer</code> and <code>window</code> (and their relatives) collect values from the source and emit them all at once â€“ after a time or when a signal appears.\nThis sounds good but is still not the right thing for us when we want to move a window forward.</p>\n<p>Finally, I cleared my mind and started all over again.\nIf there is no suitable operator for you, it&#39;s the best to think in fundamentals and begin from the ground up using low-level operators like <code>map</code>, <code>filter</code>, <code>reduce</code> and <code>scan</code>.</p>\n<h2 id=\"about-the-scan-operator\">About the scan operator</h2>\n<p>When you read about the <a href=\"https://rxjs.dev/api/operators/scan\"><code>scan</code> operator</a> you often stumble upon examples that add up values, like this one:</p>\n<pre><code class=\"language-ts\"><span class=\"hljs-keyword\">import</span> { scan } <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&#x27;rxjs/operators&#x27;</span>;\n\n<span class=\"hljs-keyword\">const</span> source$ = <span class=\"hljs-title function_\">of</span>(<span class=\"hljs-number\">1</span>, <span class=\"hljs-number\">2</span>, <span class=\"hljs-number\">3</span>, <span class=\"hljs-number\">4</span>, <span class=\"hljs-number\">5</span>);\n\n<span class=\"hljs-keyword\">const</span> result$ = source$.<span class=\"hljs-title function_\">pipe</span>(\n  <span class=\"hljs-title function_\">scan</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">acc, item</span>) =&gt;</span> acc + item, <span class=\"hljs-number\">0</span>)\n);\n\n<span class=\"hljs-comment\">// Result: 1, 3, 6, 10, 15</span>\n</code></pre><p>It transforms the stream of numbers to a stream of intermediate results from the addition performed as <code>acc + item</code>.\nThe <code>scan</code> operator is also the functional basis for Redux-style state management where we reduce a stream of actions to state objects.\nBut let&#39;s take a closer look at the <code>scan</code> operator.</p>\n<p>The first argument to <code>scan</code> is a <em>reducer function</em> with two arguments itself: <code>acc</code> and <code>item</code>.\nThe argument <code>item</code> is the emitted item from the source stream.\nWhatever we return from the function will be the next item in the stream that flows <em>out</em> of the operator.\nIn a way, <code>scan</code> is similar to <code>map</code> here.\nThe key difference however is that the reducer also gets the result from its last emission as an argument (also called <em>accumulator</em>, hence the argument name <code>acc</code>).</p>\n<p>So whenever the source fires, we get the following arguments to the reducer:</p>\n<ul>\n<li>the new source item (<code>item</code>)</li>\n<li>the previously calculated result (<code>acc</code>)</li>\n</ul>\n<p>On first execution, <code>acc</code> will be undefined since there is no previous calculation.\nThis is why we can provide a <em>seed</em> value as the secound argument to <code>scan</code> which will be used as first value to <code>acc</code> then.</p>\n<p>The following code listing shows the general structure of how we use <code>scan</code>:</p>\n<pre><code class=\"language-ts\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title\">reducer</span>(acc, item) {\n  // calculate next value\n  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-type\">nextValue</span>;\n}\n\nscan(reducer, seed);\n</code></pre><p>How does all this help us with the train window now?</p>\n<h2 id=\"scanning-train-windows\">Scanning train windows</h2>\n<p>Back to our train window problem: We want to produce a stream of arrays where each contains the last <code>n</code> items from the source.\nThis array is the list we render in the UI to display the items.</p>\n<p>When the source stream looks like this (one item per line)...</p>\n<pre><code>ğŸ˜\nğŸ¦Š\nğŸ“\nğŸˆ\nğŸ•\nğŸ™\nâš½ï¸\nğŸ³\n</code></pre><p>...and <code>n</code> is 4, the result should look like this:</p>\n<pre><code><span class=\"hljs-string\">[ğŸ˜]</span>\n<span class=\"hljs-string\">[ğŸ¦Š, ğŸ˜]</span>\n<span class=\"hljs-string\">[ğŸ“, ğŸ¦Š, ğŸ˜]</span>\n<span class=\"hljs-string\">[ğŸˆ, ğŸ“, ğŸ¦Š, ğŸ˜]</span>\n<span class=\"hljs-string\">[ğŸ•, ğŸˆ, ğŸ“, ğŸ¦Š]</span>\n<span class=\"hljs-string\">[ğŸ™, ğŸ•, ğŸˆ, ğŸ“]</span>\n<span class=\"hljs-string\">[âš½ï¸, ğŸ™, ğŸ•, ğŸˆ]</span>\n<span class=\"hljs-string\">[ğŸ³, âš½ï¸, ğŸ™, ğŸ•]</span>\n</code></pre><p>Let&#39;s go ahead and scan over the source stream.\nThis means, as an output we want to create an array that contains</p>\n<ul>\n<li>the new source item at the beginning</li>\n<li>the first <code>n - 1</code> items from the last result array</li>\n</ul>\n<pre><code class=\"language-ts\"><span class=\"hljs-keyword\">const</span> n = <span class=\"hljs-number\">4</span>;\n\n<span class=\"hljs-keyword\">const</span> result$ = source$.<span class=\"hljs-title function_\">pipe</span>(\n  <span class=\"hljs-title function_\">scan</span>(<span class=\"hljs-function\">(<span class=\"hljs-params\">acc, item</span>) =&gt;</span> [item, ...acc.<span class=\"hljs-title function_\">slice</span>(<span class=\"hljs-number\">0</span>, n - <span class=\"hljs-number\">1</span>)], [])\n);\n</code></pre><p>We need to provide an empty array as seed here so that the array operation <code>.slice()</code> does not fail for an undefined value.</p>\n<p>So what can we achieve with this pattern? There are many possible practical cases: displaying the latest logging entries, the latest stock prices or just the latest tweets about a topic like <code>#Angular</code>.\nThink of a stream of events that you want to display in realtime, but truncated: then this example is for you.</p>\n<h2 id=\"extra-build-a-custom-operator\">Extra: Build a custom operator</h2>\n<p>To hide the complexity we can wrap this thing into a custom operator.\nI wrote a dedicated blog post about this topic here: <a href=\"https://angular.schule/blog/2018-02-rxjs-own-log-operator\">Build your own RxJS logging operator</a>.</p>\n<pre><code class=\"language-ts\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">shiftWindow</span>(<span class=\"hljs-params\">n: number = <span class=\"hljs-number\">4</span></span>) {\n  <span class=\"hljs-keyword\">return</span> scan(<span class=\"hljs-function\">(<span class=\"hljs-params\">acc, item</span>) =&gt;</span> [item, ...acc.<span class=\"hljs-built_in\">slice</span>(<span class=\"hljs-number\">0</span>, n - <span class=\"hljs-number\">1</span>)], []);\n}\n</code></pre><pre><code class=\"language-ts\">const result<span class=\"hljs-variable\">$ </span>= source<span class=\"hljs-variable\">$.</span>pipe(\n  shiftWindow(<span class=\"hljs-number\">4</span>)\n);\n</code></pre><h2 id=\"demo\">Demo</h2>\n<p>You can find a working demo on Stackblitz:</p>\n<iframe style=\"width:100%; height: 25em\" title=\"Stackblitz-Demo\" src=\"https://stackblitz.com/edit/angular-train-window?ctl=1&embed=1&file=src/app/app.component.ts\"></iframe>\n\n\n<hr>\n<p>Special thanks to <a href=\"https://twitter.com/niklas_wortmann\">Jan-Niklas Wortmann</a> and <a href=\"https://twitter.com/JohannesHoppe\">Johannes Hoppe</a> for review and feedback.</p>\n<p><small><strong>Header image:</strong> Photo by &quot;Free-Photos&quot; on <a href=\"https://pixabay.com/de/photos/zug-wagen-fenster-eisenbahn-569323/\">Pixabay</a>, modified. The RxJS logo is under Apache License 2.0.\n</small></p>\n","meta":{"title":"Watching through a window: Building a moving window with RxJS","author":"Ferdinand Malcher","mail":"mail@fmalcher.de","published":"2020-02-04T00:00:00.000Z","lastModified":"2020-02-04T00:00:00.000Z","keywords":["RxJS","Reactive Programming","Observable"],"language":"en","header":{"url":"rxjs-train.jpg","width":1920,"height":1015},"hidden":false,"sticky":false,"darkenHeader":false}}
